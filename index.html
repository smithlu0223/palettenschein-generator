<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palettenschein Generator</title>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #111;
      color: #eee;
      padding: 1rem;
      font-size: 20px;
    }
    input, select, button, canvas {
      padding: 12px;
      margin-bottom: 14px;
      width: 100%;
      font-size: 20px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    canvas { 
      background: white; 
      border: 1px solid #888; 
      width: 100%; 
      height: 150px;
      display: block;
    }
    button {
      background-color: #2563eb;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { opacity: 0.9; }
    .container { width: 100%; padding: 1rem; }
    label { display: block; margin-top: 12px; font-weight: bold; }
    #download-buttons button { margin: 6px 0; display: block; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <form id="main-form">
      <h2>Palettenschein Generator</h2>

      <label for="nr">Nr</label>
      <input type="text" id="nr" required />

      <label for="datum">Datum</label>
      <input type="date" id="datum" required />

      <label for="spedition">Spedition</label>
      <input type="text" id="spedition" />

      <label for="empfaenger">Kunde / Empfänger</label>
      <input type="text" id="empfaenger" />

      <label for="lieferant">Lieferant</label>
      <input type="text" id="lieferant" />

      <label for="wawe">WA/WE</label>
      <select id="wawe" required>
        <option value="WA">WA</option>
        <option value="WE">WE</option>
      </select>

      <label for="euro">Europaletten</label>
      <input type="number" id="euro" required />

      <label for="einweg">Einwegpaletten</label>
      <input type="number" id="einweg" required />

      <label for="sonstiges">Sonstiger Hinweis</label>
      <input type="text" id="sonstiges" />

      <label>Unterschrift Fahrer</label>
      <canvas id="sign-fahrer"></canvas>
      <button type="button" onclick="clearCanvas('sign-fahrer')">Signatur Fahrer löschen</button>

      <label>Unterschrift d-log</label>
      <canvas id="sign-dlog"></canvas>
      <button type="button" onclick="clearCanvas('sign-dlog')">Signatur d-log löschen</button>

      <button type="submit">✅ Speichern & PDF erzeugen</button>
    </form>

    <div id="download-buttons" class="hidden">
      <h3>Downloads:</h3>
      <button id="download-pdf">⬇️ PDF Herunterladen</button>
    </div>
  </div>

  <script>
    // ⚡ 在这里粘贴 Power Automate 生成的 HTTP POST URL
    const FLOW_URL = "PASTE-YOUR-FLOW-URL-HERE";

    let pdfBlob, filename;

    function initCanvas(id) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext("2d");
      canvas.width = canvas.offsetWidth;
      canvas.height = 150;
      let drawing = false;

      const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        return { x: (e.clientX || e.touches[0].clientX) - rect.left, y: (e.clientY || e.touches[0].clientY) - rect.top };
      };

      const start = (e) => { drawing = true; const pos = getPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); };
      const draw = (e) => { if (!drawing) return; const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); };
      const stop = () => drawing = false;

      canvas.addEventListener("mousedown", start);
      canvas.addEventListener("mousemove", draw);
      canvas.addEventListener("mouseup", stop);
      canvas.addEventListener("mouseout", stop);
      canvas.addEventListener("touchstart", (e) => { e.preventDefault(); start(e); });
      canvas.addEventListener("touchmove", (e) => { e.preventDefault(); draw(e); });
      canvas.addEventListener("touchend", stop);
    }

    function clearCanvas(id) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function getSignatureData(id) {
      return document.getElementById(id).toDataURL("image/png");
    }

    document.addEventListener("DOMContentLoaded", () => {
      initCanvas("sign-fahrer");
      initCanvas("sign-dlog");
    });

    document.getElementById("main-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        Nr: document.getElementById("nr").value,
        Datum: document.getElementById("datum").value,
        Spedition: document.getElementById("spedition").value,
        Empfaenger: document.getElementById("empfaenger").value,
        Lieferant: document.getElementById("lieferant").value,
        WA_WE: document.getElementById("wawe").value,
        Europaletten: document.getElementById("euro").value,
        Einwegpaletten: document.getElementById("einweg").value,
        Hinweis: document.getElementById("sonstiges").value,
        SignFahrer: getSignatureData("sign-fahrer"),
        SignDlog: getSignatureData("sign-dlog")
      };

      // 1️⃣ 发送数据到 Power Automate → Excel
      try {
        await fetch(FLOW_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        console.log("✅ Daten an Power Automate gesendet!");
      } catch (err) {
        console.error("❌ Fehler beim Senden:", err);
      }

      // 2️⃣ 本地生成 PDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;
      doc.setFontSize(16);
      doc.text("Palettenschein", 105, y, { align: "center" });
      y += 10;
      doc.setFontSize(12);
      for (const [k, v] of Object.entries(data)) {
        if (k !== "SignFahrer" && k !== "SignDlog") {
          doc.text(`${k}: ${v}`, 20, y);
          y += 8;
        }
      }
      doc.addImage(data.SignFahrer, "PNG", 20, y, 80, 40);
      doc.text("Unterschrift Fahrer", 20, y + 45);
      doc.addImage(data.SignDlog, "PNG", 110, y, 80, 40);
      doc.text("Unterschrift d-log", 110, y + 45);

      filename = `Palettenschein-${data.Nr || Date.now()}`;
      pdfBlob = doc.output("blob");

      document.getElementById("download-buttons").classList.remove("hidden");
    });

    document.getElementById("download-pdf").addEventListener("click", () => {
      const link = document.createElement("a");
      link.href = URL.createObjectURL(pdfBlob);
      link.download = `${filename}.pdf`;
      link.click();
    });
  </script>
</body>
</html>
