<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palettenschein Generator</title>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #111;
      color: #eee;
      padding: 1rem;
      font-size: 20px;   /* ÈªòËÆ§Â≠ó‰ΩìÊõ¥Â§ß */
    }
    .hidden { display: none; }
    input, select, button, canvas {
      padding: 12px;
      margin-bottom: 14px;
      width: 100%;
      font-size: 20px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    canvas { 
      background: white; 
      border: 1px solid #888; 
      width: 100%;     /* ‚úÖ ÂÆΩÂ∫¶Ëá™ÈÄÇÂ∫î */
      height: 150px;   /* ‚úÖ È´òÂ∫¶Êõ¥Â§ßÔºåÈÄÇÂêàÁ≠æÂ≠ó */
      display: block;
    }
    button {
      background-color: #2563eb;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { opacity: 0.9; }
    .container { 
      width: 100%; 
      padding: 1rem; 
    }
    label { display: block; margin-top: 12px; font-weight: bold; }
    #download-buttons button { margin: 6px 0; display: block; }

    /* ÊâãÊú∫ÈÄÇÈÖç */
    @media (max-width: 600px) {
      body {
        font-size: 22px;  /* ÊâãÊú∫‰∏äÂÜçÊîæÂ§ß‰∏ÄÁÇπ */
        padding: 1rem;
      }
      input, select, button, canvas {
        font-size: 22px;
        padding: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="login-box" class="hidden">
      <h2>üîê Passwort</h2>
      <input type="password" id="password-input" placeholder="Gib das Passwort ein" />
      <button onclick="checkPassword()">Login</button>
      <p id="login-error" style="color: red; display: none;">‚ùå Falsches Passwort!</p>
    </div>

    <form id="main-form" class="hidden">
      <h2>Palettenschein Generator</h2>

      <label for="company">Spedition w√§hlen</label>
      <select id="company" onchange="handleCompanyChange()" required>
        <option value="DHL">DHL</option>
        <option value="Intern">Intern</option>
        <option value="GLS">GLS</option>
      </select>

      <label for="nr">Nr</label>
      <input type="text" id="nr" required readonly />

      <label for="datum">Datum</label>
      <input type="date" id="datum" required />

      <label for="spedition">Spedition</label>
      <input type="text" id="spedition" readonly />

      <label for="empfaenger">Kunde / Empf√§nger</label>
      <input type="text" id="empfaenger" />

      <label for="lieferant">Lieferant</label>
      <input type="text" id="lieferant" />

      <label for="wawe">WA/WE</label>
      <select id="wawe" required>
        <option value="WA">WA</option>
        <option value="WE">WE</option>
      </select>

      <label for="euro">Europaletten</label>
      <input type="number" id="euro" required />

      <label for="einweg">Einwegpaletten</label>
      <input type="number" id="einweg" required />

      <label for="sonstiges">Sonstiger Hinweis</label>
      <input type="text" id="sonstiges" />

      <label>Unterschrift Fahrer</label>
      <canvas id="sign-fahrer"></canvas>
      <button type="button" onclick="clearCanvas('sign-fahrer')">Signatur Fahrer l√∂schen</button>

      <label>Unterschrift d-log</label>
      <canvas id="sign-dlog"></canvas>
      <button type="button" onclick="clearCanvas('sign-dlog')">Signatur d-log l√∂schen</button>

      <button type="submit">Daten Erzeugen</button>
    </form>

    <div id="download-buttons" class="hidden">
      <h3>Downloads:</h3>
      <button id="download-pdf">‚¨áÔ∏è PDF Herunterladen</button>
      <button id="finish-btn" class="hidden">‚úÖ Fertig</button>
    </div>
  </div>

  <script>
    const PASSWORD = "Dlog2025";
    let pdfBlob, filename;

    window.onload = () => {
      if (localStorage.getItem("authenticated") === "true") {
        document.getElementById("main-form").classList.remove("hidden");
        initCanvas("sign-fahrer");
        initCanvas("sign-dlog");
        handleCompanyChange();
      } else {
        document.getElementById("login-box").classList.remove("hidden");
      }
    };

    function checkPassword() {
      const pw = document.getElementById("password-input").value;
      if (pw === PASSWORD) {
        localStorage.setItem("authenticated", "true");
        document.getElementById("login-box").style.display = "none";
        document.getElementById("main-form").classList.remove("hidden");
        initCanvas("sign-fahrer");
        initCanvas("sign-dlog");
        handleCompanyChange();
      } else {
        document.getElementById("login-error").style.display = "block";
      }
    }

    function generateBerlinTimestamp() {
      const date = new Date();
      const options = { timeZone: "Europe/Berlin", year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" };
      const berlinTime = new Intl.DateTimeFormat("de-DE", options).format(date);
      const [d, m, y] = berlinTime.split(",")[0].split(".");
      const [h, min] = berlinTime.split(",")[1].trim().split(":");
      return `${y}${m}${d}-${h}${min}`;
    }

    function handleCompanyChange() {
      const company = document.getElementById("company").value;
      const nrField = document.getElementById("nr");
      const speditionField = document.getElementById("spedition");
      const timestamp = generateBerlinTimestamp();

      if (company === "GLS") {
        nrField.removeAttribute("readonly");
        nrField.value = "";
        speditionField.setAttribute("readonly", true);
        speditionField.value = "GLS";
      } else if (company === "DHL") {
        nrField.setAttribute("readonly", true);
        nrField.value = timestamp;
        speditionField.setAttribute("readonly", true);
        speditionField.value = "DHL";
      } else if (company === "Intern") {
        nrField.setAttribute("readonly", true);
        nrField.value = timestamp;
        speditionField.removeAttribute("readonly");
        speditionField.value = "";
      }

      const berlin = new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Berlin" }));
      const yyyy = berlin.getFullYear();
      const mm = String(berlin.getMonth() + 1).padStart(2, "0");
      const dd = String(berlin.getDate()).padStart(2, "0");
      document.getElementById("datum").value = `${yyyy}-${mm}-${dd}`;
    }

    function initCanvas(id) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext("2d");

      // ‚úÖ Ëá™ÈÄÇÂ∫îÂÆΩÂ∫¶ÂíåÂõ∫ÂÆöÈ´òÂ∫¶
      canvas.width = canvas.offsetWidth;
      canvas.height = 150;

      let drawing = false;

      const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        return {
          x: (e.clientX || e.touches[0].clientX) - rect.left,
          y: (e.clientY || e.touches[0].clientY) - rect.top
        };
      };

      const start = (e) => {
        drawing = true;
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      };

      const draw = (e) => {
        if (!drawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
      };

      const stop = () => drawing = false;

      // Èº†Ê†á‰∫ã‰ª∂
      canvas.addEventListener("mousedown", start);
      canvas.addEventListener("mousemove", draw);
      canvas.addEventListener("mouseup", stop);
      canvas.addEventListener("mouseout", stop);

      // Ëß¶Êë∏‰∫ã‰ª∂
      canvas.addEventListener("touchstart", (e) => { e.preventDefault(); start(e); });
      canvas.addEventListener("touchmove", (e) => { e.preventDefault(); draw(e); });
      canvas.addEventListener("touchend", stop);
    }

    function clearCanvas(id) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function getSignatureData(id) {
      return document.getElementById(id).toDataURL("image/png");
    }

    document.getElementById("main-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const data = {
        Datum: document.getElementById("datum").value,
        Nr: document.getElementById("nr").value,
        Spedition: document.getElementById("spedition").value,
        Empfaenger: document.getElementById("empfaenger").value,
        Lieferant: document.getElementById("lieferant").value,
        WA_WE: document.getElementById("wawe").value,
        Europaletten: document.getElementById("euro").value,
        Einwegpaletten: document.getElementById("einweg").value,
        Hinweis: document.getElementById("sonstiges").value
      };
      const signFahrer = getSignatureData("sign-fahrer");
      const signDlog = getSignatureData("sign-dlog");

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;
      doc.setFontSize(16);
      doc.text("Palettenschein", 105, y, { align: "center" });
      y += 10;
      doc.setFontSize(12);
      for (const [k, v] of Object.entries(data)) {
        doc.text(`${k}: ${v}`, 20, y);
        y += 8;
      }
      doc.addImage(signFahrer, "PNG", 20, y, 80, 40);
      doc.text("Unterschrift Fahrer", 20, y + 45);
      doc.addImage(signDlog, "PNG", 110, y, 80, 40);
      doc.text("Unterschrift d-log", 110, y + 45);

      let nr = data.Nr?.trim() || generateBerlinTimestamp();
      nr = nr.replace(/[\\/:*?"<>|]/g, "-");
      filename = `Palettenschein Nr ${nr}`;
      pdfBlob = doc.output("blob");

      document.getElementById("download-buttons").classList.remove("hidden");
    });

    document.getElementById("download-pdf").addEventListener("click", () => {
      const link = document.createElement("a");
      link.href = URL.createObjectURL(pdfBlob);
      link.download = `${filename}.pdf`;
      link.click();
      document.getElementById("finish-btn").classList.remove("hidden");
    });

    document.getElementById("finish-btn").addEventListener("click", () => {
      document.getElementById("main-form").reset();
      clearCanvas("sign-fahrer");
      clearCanvas("sign-dlog");
      document.getElementById("download-buttons").classList.add("hidden");
      document.getElementById("finish-btn").classList.add("hidden");
    });
  </script>
</body>
</html>
