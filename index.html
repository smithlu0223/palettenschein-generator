<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Palettenschein Generator</title>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    .hidden { display: none; }
    input, select, button, canvas {
      padding: 8px;
      margin-bottom: 10px;
      width: 100%;
      max-width: 300px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    canvas { background: white; border: 1px solid #888; }
    button {
      background-color: #2563eb;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { opacity: 0.9; }
    .container { max-width: 400px; width: 100%; }
    label { display: block; margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <div id="login-box">
      <h2>üîê Passwort</h2>
      <input type="password" id="password-input" placeholder="Gib das Passwort ein" />
      <button onclick="checkPassword()">Login</button>
      <p id="login-error" style="color: red; display: none;">‚ùå Falsches Passwort!</p>
    </div>

    <form id="main-form" class="hidden">
      <h2>Palettenschein Generator</h2>

      <label for="company">Spedition w√§hlen</label>
      <select id="company" onchange="handleCompanyChange()" required>
        <option value="DHL">DHL</option>
        <option value="Intern">Intern</option>
        <option value="GLS">GLS</option>
      </select>

      <label for="nr">Nr</label>
      <input type="text" id="nr" required readonly />

      <label for="datum">Datum</label>
      <input type="date" id="datum" required />

      <label for="spedition">Spedition</label>
      <input type="text" id="spedition" readonly />

      <label for="empfaenger">Kunde / Empf√§nger</label>
      <input type="text" id="empfaenger" />

      <label for="lieferant">Lieferant</label>
      <input type="text" id="lieferant" />

      <label for="lieferschein">Lieferschein-Nr.</label>
      <input type="text" id="lieferschein" required />

      <label for="euro">Europaletten</label>
      <input type="number" id="euro" required />

      <label for="einweg">Einwegpaletten</label>
      <input type="number" id="einweg" required />

      <label for="sonstiges">Sonstiger Hinweis</label>
      <input type="text" id="sonstiges" />

      <label>Unterschrift Fahrer</label>
      <canvas id="sign-fahrer" width="300" height="100"></canvas>
      <button type="button" onclick="clearCanvas('sign-fahrer')">Signatur Fahrer l√∂schen</button>

      <label>Unterschrift d-log</label>
      <canvas id="sign-dlog" width="300" height="100"></canvas>
      <button type="button" onclick="clearCanvas('sign-dlog')">Signatur d-log l√∂schen</button>

      <button type="submit">PDF + Excel Erstellen</button>
    </form>
  </div>

  <script>
    const PASSWORD = "Dlog2025";

    function checkPassword() {
      const pw = document.getElementById("password-input").value;
      if (pw === PASSWORD) {
        document.getElementById("login-box").style.display = "none";
        document.getElementById("main-form").classList.remove("hidden");
        initCanvas("sign-fahrer");
        initCanvas("sign-dlog");
        handleCompanyChange(); // ÂàùÂßãÂåñÈÄªËæë
      } else {
        document.getElementById("login-error").style.display = "block";
      }
    }

    function generateBerlinTimestamp() {
      const date = new Date();
      const options = {
        timeZone: "Europe/Berlin",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      };
      const berlinTime = new Intl.DateTimeFormat("de-DE", options).format(date);
      const [d, m, y] = berlinTime.split(",")[0].split(".");
      const [h, min] = berlinTime.split(",")[1].trim().split(":");
      return `${y}${m}${d}-${h}${min}`;
    }

    function handleCompanyChange() {
      const company = document.getElementById("company").value;
      const nrField = document.getElementById("nr");
      const speditionField = document.getElementById("spedition");
      const timestamp = generateBerlinTimestamp();

      if (company === "GLS") {
        nrField.removeAttribute("readonly");
        nrField.value = "";
        speditionField.setAttribute("readonly", true);
        speditionField.value = "GLS";
      } else if (company === "DHL") {
        nrField.setAttribute("readonly", true);
        nrField.value = timestamp;
        speditionField.setAttribute("readonly", true);
        speditionField.value = "DHL";
      } else if (company === "Intern") {
        nrField.setAttribute("readonly", true);
        nrField.value = timestamp;
        speditionField.removeAttribute("readonly"); // ‚úÖ ÂèØÁºñËæë
        speditionField.value = ""; // ‚úÖ Ê∏ÖÁ©∫
      }

      const berlin = new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Berlin" }));
      const yyyy = berlin.getFullYear();
      const mm = String(berlin.getMonth() + 1).padStart(2, "0");
      const dd = String(berlin.getDate()).padStart(2, "0");
      document.getElementById("datum").value = `${yyyy}-${mm}-${dd}`;
    }

    function initCanvas(id) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext("2d");
      let drawing = false;

      const start = (e) => {
        drawing = true;
        const pos = getPosition(e, canvas);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      };

      const draw = (e) => {
        if (!drawing) return;
        const pos = getPosition(e, canvas);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
      };

      const stop = () => drawing = false;

      canvas.addEventListener("mousedown", start);
      canvas.addEventListener("mousemove", draw);
      canvas.addEventListener("mouseup", stop);
      canvas.addEventListener("mouseout", stop);
      canvas.addEventListener("touchstart", (e) => {
        e.preventDefault();
        start(e.touches[0]);
      });
      canvas.addEventListener("touchmove", (e) => {
        e.preventDefault();
        draw(e.touches[0]);
      });
      canvas.addEventListener("touchend", stop);
    }

    function getPosition(e, canvas) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    }

    function clearCanvas(id) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function getSignatureData(id) {
      return document.getElementById(id).toDataURL("image/png");
    }

    document.getElementById("main-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const data = {
        Datum: document.getElementById("datum").value,
        Nr: document.getElementById("nr").value,
        Spedition: document.getElementById("spedition").value,
        "Kunde/Empf√§nger": document.getElementById("empfaenger").value,
        Lieferant: document.getElementById("lieferant").value,
        "Lieferschein-Nr.": document.getElementById("lieferschein").value,
        Europaletten: document.getElementById("euro").value,
        Einwegpaletten: document.getElementById("einweg").value,
        "Sonstiger Hinweis": document.getElementById("sonstiges").value
      };

      const signFahrer = getSignatureData("sign-fahrer");
      const signDlog = getSignatureData("sign-dlog");

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;

      doc.setFontSize(16);
      doc.text("Palettenschein", 105, y, { align: "center" });
      y += 10;
      doc.setFontSize(12);
      for (const [k, v] of Object.entries(data)) {
        doc.text(`${k}: ${v}`, 20, y);
        y += 8;
      }

      doc.addImage(signFahrer, "PNG", 20, y, 60, 25);
      doc.text("Unterschrift Fahrer", 20, y + 30);
      doc.addImage(signDlog, "PNG", 110, y, 60, 25);
      doc.text("Unterschrift d-log", 110, y + 30);

      let nr = data.Nr?.trim() || generateBerlinTimestamp();
      nr = nr.replace(/[\\/:*?"<>|]/g, "-");
      const filename = `Palettenschein Nr ${nr}`;

      doc.save(`${filename}.pdf`);

      const ws = XLSX.utils.json_to_sheet([data]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Palettenschein");
      XLSX.writeFile(wb, `${filename}.xlsx`);

      alert("PDF und Excel erfolgreich erstellt.");
      document.getElementById("main-form").reset();
      clearCanvas("sign-fahrer");
      clearCanvas("sign-dlog");
      handleCompanyChange(); // ÈáçÁΩÆÂàùÂßãÂåñ
    });
  </script>
</body>
</html>
