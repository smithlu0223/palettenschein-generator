<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Palettenschein Generator</title>
  <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, select, button, canvas { margin: 8px 0; width: 100%; padding: 8px; }
    canvas { background: #fff; border: 1px solid #ccc; height: 150px; }
    #download-buttons { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Palettenschein Generator</h2>

  <form id="main-form">
    <label for="company">Spedition wählen</label>
    <select id="company" onchange="handleCompanyChange()" required>
      <option value="DHL">DHL</option>
      <option value="Intern">Intern</option>
      <option value="GLS">GLS</option>
    </select>

    <label>Nr</label>
    <input type="text" id="nr" required readonly />

    <label>Datum</label>
    <input type="date" id="datum" required />

    <label>Spedition</label>
    <input type="text" id="spedition" readonly />

    <label>Empfänger</label>
    <input type="text" id="empfaenger" />

    <label>Lieferant</label>
    <input type="text" id="lieferant" />

    <label>WA/WE</label>
    <select id="wawe">
      <option value="WA">WA</option>
      <option value="WE">WE</option>
    </select>

    <label>Europaletten</label>
    <input type="number" id="euro" />

    <label>Einwegpaletten</label>
    <input type="number" id="einweg" />

    <label>Hinweis</label>
    <input type="text" id="hinweis" />

    <label>Unterschrift Fahrer</label>
    <canvas id="sign-fahrer"></canvas>

    <label>Unterschrift d-log</label>
    <canvas id="sign-dlog"></canvas>

    <button type="submit">✅ Speichern & PDF erzeugen</button>
  </form>

  <div id="download-buttons" style="display:none;">
    <button id="download-pdf">⬇️ PDF Herunterladen</button>
  </div>

  <script>
    // ------------------ MSAL 配置 ------------------
    const msalConfig = {
      auth: {
        clientId: "HIER-DEIN-APP-ID", // ⚡ 在 Azure 注册应用时生成的 Client ID
        authority: "https://login.microsoftonline.com/common/",
        redirectUri: window.location.origin
      }
    };
    const msalInstance = new msal.PublicClientApplication(msalConfig);
    let accessToken = null;

    async function login() {
      const result = await msalInstance.loginPopup({
        scopes: ["Files.ReadWrite"]
      });
      accessToken = result.accessToken;
    }

    // ------------------ Nr & Spedition 逻辑 ------------------
    function generateBerlinTimestamp() {
      const date = new Date();
      const options = { timeZone: "Europe/Berlin", year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" };
      const berlinTime = new Intl.DateTimeFormat("de-DE", options).format(date);
      const [d, m, y] = berlinTime.split(",")[0].split(".");
      const [h, min] = berlinTime.split(",")[1].trim().split(":");
      return `${y}${m}${d}-${h}${min}`;
    }

    function handleCompanyChange() {
      const company = document.getElementById("company").value;
      const nrField = document.getElementById("nr");
      const speditionField = document.getElementById("spedition");
      const timestamp = generateBerlinTimestamp();

      if (company === "GLS") {
        nrField.removeAttribute("readonly");
        nrField.value = "";
        speditionField.setAttribute("readonly", true);
        speditionField.value = "GLS";
      } else if (company === "DHL") {
        nrField.setAttribute("readonly", true);
        nrField.value = timestamp;
        speditionField.setAttribute("readonly", true);
        speditionField.value = "DHL";
      } else if (company === "Intern") {
        nrField.setAttribute("readonly", true);
        nrField.value = timestamp;
        speditionField.removeAttribute("readonly");
        speditionField.value = "";
      }

      // 自动设置 Datum 为当天
      const berlin = new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Berlin" }));
      const yyyy = berlin.getFullYear();
      const mm = String(berlin.getMonth() + 1).padStart(2, "0");
      const dd = String(berlin.getDate()).padStart(2, "0");
      document.getElementById("datum").value = `${yyyy}-${mm}-${dd}`;
    }

    // ------------------ Canvas 签名 ------------------
    function initCanvas(id) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext("2d");
      canvas.width = canvas.offsetWidth;
      canvas.height = 150;
      let drawing = false;

      const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        return { x: (e.clientX || e.touches[0].clientX) - rect.left, y: (e.clientY || e.touches[0].clientY) - rect.top };
      };

      canvas.addEventListener("mousedown", (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); });
      canvas.addEventListener("mousemove", (e) => { if (drawing) { const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); } });
      canvas.addEventListener("mouseup", () => drawing = false);
      canvas.addEventListener("mouseout", () => drawing = false);
      canvas.addEventListener("touchstart", (e) => { e.preventDefault(); drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
      canvas.addEventListener("touchmove", (e) => { e.preventDefault(); if (drawing) { const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); } });
      canvas.addEventListener("touchend", () => drawing = false);
    }
    function getSignatureData(id) {
      return document.getElementById(id).toDataURL("image/png");
    }
    initCanvas("sign-fahrer");
    initCanvas("sign-dlog");
    handleCompanyChange();

    // ------------------ CSV 处理 ------------------
    function convertToCSVRow(data) {
      return `${data.Nr},${data.Datum},${data.Spedition},${data.Empfaenger},${data.Lieferant},${data.WA_WE},${data.Europaletten},${data.Einwegpaletten},${data.Hinweis}\n`;
    }

    async function appendToCsvOnOneDrive(row) {
      const filePath = "/Palettenschein/data.csv";
      const getUrl = `https://graph.microsoft.com/v1.0/me/drive/root:${filePath}:/content`;
      const oldFile = await fetch(getUrl, { headers: { Authorization: `Bearer ${accessToken}` } });
      const oldText = oldFile.ok ? await oldFile.text() : "Nr,Datum,Spedition,Empfaenger,Lieferant,WA_WE,Europaletten,Einwegpaletten,Hinweis\n";
      const newText = oldText + row;
      const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:${filePath}:/content`;
      await fetch(uploadUrl, {
        method: "PUT",
        headers: { Authorization: `Bearer ${accessToken}` },
        body: new Blob([newText], { type: "text/csv" })
      });
    }

    // ------------------ 表单提交 ------------------
    document.getElementById("main-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!accessToken) {
        await login(); // 第一次需要登录微软账号
      }

      const data = {
        Nr: document.getElementById("nr").value,
        Datum: document.getElementById("datum").value,
        Spedition: document.getElementById("spedition").value,
        Empfaenger: document.getElementById("empfaenger").value,
        Lieferant: document.getElementById("lieferant").value,
        WA_WE: document.getElementById("wawe").value,
        Europaletten: document.getElementById("euro").value,
        Einwegpaletten: document.getElementById("einweg").value,
        Hinweis: document.getElementById("hinweis").value,
        SignFahrer: getSignatureData("sign-fahrer"),
        SignDlog: getSignatureData("sign-dlog")
      };

      // 1️⃣ 写入 CSV
      const row = convertToCSVRow(data);
      await appendToCsvOnOneDrive(row);

      // 2️⃣ 生成 PDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Palettenschein", 105, 20, { align: "center" });
      let y = 30;
      for (const [k, v] of Object.entries(data)) {
        if (k !== "SignFahrer" && k !== "SignDlog") {
          doc.text(`${k}: ${v}`, 20, y);
          y += 10;
        }
      }
      doc.addImage(data.SignFahrer, "PNG", 20, y, 80, 40);
      doc.text("Unterschrift Fahrer", 20, y + 45);
      doc.addImage(data.SignDlog, "PNG", 110, y, 80, 40);
      doc.text("Unterschrift d-log", 110, y + 45);

      const pdfBlob = doc.output("blob");
      const filename = `Palettenschein-${data.Nr}.pdf`;
      const link = document.createElement("a");
      link.href = URL.createObjectURL(pdfBlob);
      link.download = filename;
      link.click();

      document.getElementById("download-buttons").style.display = "block";
    });
  </script>
</body>
</html>
